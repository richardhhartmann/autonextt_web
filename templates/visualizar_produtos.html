{% extends "base.html" %}

{% block title %}Visualizar Produtos{% endblock %}

{% block content %}
<div class="container mx-auto">
    <div class="flex justify-between items-center mb-6 gap-4">
        <h1 class="text-3xl font-bold text-gray-800 flex-shrink-0">Lista de Produtos</h1>
        
        <div class="flex-grow mx-4">
            <input type="search" id="search-box" placeholder="Pesquisar por descrição, marca, referência..." class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>

        <a href="{{ url_for('cadastrar_produto') }}" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-300 flex items-center flex-shrink-0">
            <i class="fas fa-plus mr-2"></i>
            Novo Produto
        </a>
    </div>

    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full leading-normal">
                <thead>
                    <tr class="border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        {% for coluna in colunas %}
                        <th class="px-5 py-3">{{ coluna }}</th>
                        {% endfor %}
                        <th class="px-5 py-3 text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="product-table-body">
                    <!-- Linhas de produtos serão inseridas aqui via JS -->
                </tbody>
            </table>
        </div>
        <div id="loading-indicator" class="text-center p-4 hidden">
            <i class="fas fa-spinner fa-spin fa-2x text-gray-500"></i>
            <p>Carregando mais produtos...</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const tableBody = document.getElementById('product-table-body');
    const loadingIndicator = document.getElementById('loading-indicator');
    const searchBox = document.getElementById('search-box');

    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;
    let currentSearch = '';
    let searchTimeout;

    const colunas = {{ colunas | tojson }};

    function createTableRow(produto) {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-200 hover:bg-gray-100 group';

        let cells = '';
        colunas.forEach(colunaKey => {
            let cellValue = produto[colunaKey];
            if (colunaKey === 'Ativo') {
                cellValue = produto[colunaKey]
                    ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Ativo</span>`
                    : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Inativo</span>`;
            } else {
                cellValue = cellValue !== null ? cellValue : 'N/A';
            }
            cells += `<td class="px-5 py-4 text-sm text-gray-800">${cellValue}</td>`;
        });
        
        const editUrl = `/produtos/editar/${produto.sec_codigo}/${produto.esp_codigo}/${produto.prd_codigo}`;
        const deleteUrl = `/produtos/excluir/${produto.sec_codigo}/${produto.esp_codigo}/${produto.prd_codigo}`;

        cells += `
            <td class="px-5 py-4 text-sm text-center">
                <div class="opacity-0 group-hover:opacity-100 flex justify-center space-x-3 transition-opacity">
                    <a href="${editUrl}" class="text-blue-600 hover:text-blue-900" title="Editar">
                        <i class="fas fa-edit fa-lg"></i>
                    </a>
                    <form action="${deleteUrl}" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir este produto? Esta ação não pode ser desfeita.');">
                        <button type="submit" class="text-red-600 hover:text-red-900" title="Excluir">
                            <i class="fas fa-trash-alt fa-lg"></i>
                        </button>
                    </form>
                </div>
            </td>`;
        
        row.innerHTML = cells;
        return row;
    }

    async function fetchProducts(page = 1, search = '') {
        if (isLoading || !hasMore) return;
        isLoading = true;
        loadingIndicator.classList.remove('hidden');

        try {
            const response = await fetch(`/api/produtos?page=${page}&search=${search}`);
            if (!response.ok) {
                throw new Error('Falha ao carregar os dados.');
            }
            const produtos = await response.json();

            if (page === 1) {
                tableBody.innerHTML = ''; // Limpa a tabela para nova busca ou recarga
            }

            if (produtos.length > 0) {
                produtos.forEach(produto => {
                    tableBody.appendChild(createTableRow(produto));
                });
                currentPage++;
            } else {
                hasMore = false;
                if (page === 1) {
                    tableBody.innerHTML = `<tr><td colspan="${colunas.length + 1}" class="text-center py-10 text-gray-500">Nenhum produto encontrado.</td></tr>`;
                }
            }
        } catch (error) {
            console.error('Erro:', error);
            tableBody.innerHTML = `<tr><td colspan="${colunas.length + 1}" class="text-center py-10 text-red-500">Erro ao carregar produtos.</td></tr>`;
        } finally {
            isLoading = false;
            loadingIndicator.classList.add('hidden');
        }
    }

    // Carregamento inicial
    fetchProducts(currentPage, currentSearch);

    // Lógica de "infinite scroll"
    window.addEventListener('scroll', () => {
        if (window.innerHeight + window.scrollY >= document.documentElement.offsetHeight - 100) {
            if (hasMore && !isLoading) {
                fetchProducts(currentPage, currentSearch);
            }
        }
    });

    // Lógica de busca com debounce
    searchBox.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentSearch = e.target.value;
            currentPage = 1;
            hasMore = true;
            fetchProducts(currentPage, currentSearch);
        }, 500); // Espera 500ms após o usuário parar de digitar
    });
});
</script>
{% endblock %}
